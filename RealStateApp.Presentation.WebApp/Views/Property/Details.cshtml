@using RealStateApp.Core.Application.ViewModels
@using RealStateApp.Core.Domain.Enums
@model PropertyDetailsViewModel
@{
    var isAgent = false;
    if (Model.Rol != null)
    {
        isAgent = Model.Rol == UserRoles.Agent.ToString();
        Layout = Model.Rol == UserRoles.Client.ToString() ? "_ClientLayout" : "_AgentLayout";

    }
    else
    {

        Layout = "_GeneralLayout";
    }
    ViewData["Title"] = "Detalle Propiedad";
    bool hasPendingOrAcceptedOffer = false;
    if(Model.Offers != null)
    {

        hasPendingOrAcceptedOffer = Model.Offers!.Any(o => o.Status == Status.Pending || o.Status == Status.Accepted);
    }
}

<div class="container my-4">
    <div class="row g-4">
        <!-- Columna izquierda -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <!-- Carrusel -->
                <div id="propertyCarousel" class="carousel slide" data-bs-ride="carousel" style="max-height: 450px;">
                    <div class="carousel-inner">
                        @if (Model.Property.Images != null && Model.Property.Images.Any())
                        {
                            int i = 0;
                            foreach (var img in Model.Property.Images)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@img.Url" class="d-block w-100" style="object-fit: cover; height: 450px;" alt="Imagen propiedad" />
                                </div>
                                i++;
                            }
                        }
                        else
                        {
                            <div class="carousel-item active bg-secondary d-flex align-items-center justify-content-center" style="height:450px;">
                                <span class="text-white">No hay imágenes</span>
                            </div>
                        }
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    </button>
                </div>

                <!-- Info -->
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-secondary"><i class="bi bi-key"></i> Código: @Model.Property.Code</span>
                        <span class="badge bg-info text-dark"><i class="bi bi-house-door"></i> @Model.Property.PropertyType.Name</span>
                        <span class="badge bg-warning text-dark"><i class="bi bi-tags"></i> @Model.Property.SaleType.Name</span>
                    </div>

                    <h3 class="text-success fw-bold">RD$ @Model.Property.Price.ToString("N0")</h3>

                    <div class="d-flex gap-4 my-3 text-muted">
                        <span><i class="bi bi-door-closed"></i> @Model.Property.Bedrooms @(Model.Property.Bedrooms > 1 ? "Habitaciones" : "Habitación")</span>
                        <span><i class="bi bi-bucket"></i> @Model.Property.Bathrooms Baño(s)</span>
                        <span><i class="bi bi-arrows-angle-expand"></i> @Model.Property.SizeInMeters m²</span>
                    </div>

                    <h5 class="mt-4">Descripción</h5>
                    <p class="text-secondary">@Model.Property.Description</p>
                    @if (Model.Property.PropertyImprovements != null && Model.Property.PropertyImprovements.Any())
                    {
                        <p class="mt-2 mb-1"><strong>Mejoras:</strong></p>
                        <ul class="list-unstyled mb-0">
                            @foreach (var improvement in Model.Property.PropertyImprovements)
                            {
                                <li class="d-inline-block me-3">
                                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                                    @improvement.Improvement.Name
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>

        <!-- Columna derecha -->
        <div class="col-lg-4">
            <!-- Agente -->
            <div class="card p-3 shadow-sm mb-4">
                <h6 class="text-primary fw-bold">Asesor inmobiliario</h6>
                <div class="d-flex align-items-center mb-3">
                    <img src=@Model.Agent.PhotoPath
                    alt="Foto agente"
                    class="rounded-circle me-3"
                    style="width: 70px; height: 70px; object-fit: cover;">
                    <div>
                        <p class="mb-1 fw-semibold">@Model.Agent.FirstName @Model.Agent.LastName</p>
                        <p class="mb-0 text-muted"><i class="bi bi-whatsapp"></i> @Model.Agent.PhoneNumber</p>
                        <p class="mb-0 text-muted"><i class="bi bi-envelope"></i> @Model.Agent.Email</p>
                    </div>
                </div>
                <a class="btn btn-success w-100"
                   href="https://wa.me/@Model.Agent.PhoneNumber?text=Hola, estoy interesado en una propiedad que vi en la página."
                   target="_blank">
                    <i class="bi bi-whatsapp"></i> Solicitar Asesoría
                </a>
            </div>
            @if (Model.Addons)
            {
                if(!isAgent)
                {
                    
                
                <!-- Chat -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-chat-dots"></i> Chat con el agente
                    </div>

                    @if (Model.Chat?.Messages != null && Model.Chat.Messages.Any())
                    {
                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                            @foreach (var msg in Model.Chat.Messages)
                            {
                                if (msg.isFromClient)
                                {
                                    <!-- Mensaje del cliente -->
                                    <div class="d-flex justify-content-end mb-2">
                                        <div class="p-2 rounded bg-success text-white shadow-sm" style="max-width: 70%;">
                                            <strong>Tú:</strong> @msg.Content
                                            <div class="text-light" style="font-size: 0.8rem;">@msg.Date.ToString("g")</div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <!-- Mensaje del agente -->
                                    <div class="d-flex justify-content-start mb-2">
                                        <div class="p-2 rounded bg-primary text-white shadow-sm" style="max-width: 70%;">
                                            <strong>Agente:</strong> @msg.Content
                                            <div class="text-light" style="font-size: 0.8rem;">@msg.Date.ToString("g")</div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }
                    else
                    {
                        <div class="card-body text-center text-muted">
                            No hay mensajes aún.
                        </div>
                    }

                    <!-- Footer del chat -->
                    <div class="card-footer">
                        @if (TempData["ErrorMessage"] != null)
                        {
                            <div class="alert alert-danger mt-2">@TempData["ErrorMessage"]</div>
                        }

                        <form asp-controller="Addons" asp-action="AddMessage" method="post" class="d-flex w-100">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="propertyId" value="@Model.Property.Id" />
                            <input type="hidden" name="chatId" value="@Model.Chat.ChatId" />

                            <input name="message" type="text" class="form-control me-2" placeholder="Escribe tu mensaje..." required />
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>
                    </div>
                </div>
            


            <!-- Ofertas -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-cash-coin"></i> Mis Ofertas</span>
                    <button class="btn btn-light btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#modalNuevaOferta"
                    @(hasPendingOrAcceptedOffer ? "disabled" : "")>
                        <i class="bi bi-plus-circle"></i> Nueva oferta
                    </button>
                </div>
                <div class="card-body">
                    @if (Model.Offers!.Any())
                    {
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var offer in Model.Offers!)
                                {
                                    <tr>
                                        <td>@offer.Date.ToString("dd/MM/yyyy")</td>
                                        <td>RD$ @offer.Amount.ToString()</td>
                                        <td>
                                            @if (offer.Status == Status.Pending)
                                            {
                                                <span class="badge bg-warning text-dark">Pendiente</span>
                                            }
                                                else if (offer.Status == Status.Accepted)
                                            {
                                                <span class="badge bg-success">Aceptada</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Rechazada</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted">No has hecho ofertas todavía.</p>
                    }
                </div>
            </div>

            <!-- Modal Nueva Oferta -->
                <div class="modal fade" id="modalNuevaOferta" tabindex="-1" aria-labelledby="modalNuevaOfertaLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form asp-controller="Addons" asp-action="AddOffer" method="post">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title" id="modalNuevaOfertaLabel">Hacer nueva oferta</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                </div>

                                <div class="modal-body">
                                    <!-- Campo oculto con el ID de la propiedad -->
                                    <input type="hidden" name="PropertyId" value="@Model.Property.Id" />

                                    <div class="mb-3">
                                        <label for="montoOferta" class="form-label">Monto (RD$)</label>
                                        <input type="number" class="form-control" id="montoOferta" name="amountOffer"
                                               placeholder="Ej: 5400000" required min="1" step="0.01" />
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-send"></i> Enviar oferta
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
               }
                else
                {
                    <!-- Vista del agente -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-chat-dots"></i> Chats con clientes
                        </div>
                        <div class="list-group list-group-flush">
                            @if (Model.AgentChat != null && Model.AgentChat.Any())
                            {
                                @foreach (var chat in Model.AgentChat)
                                {
                                    <button type="button"
                                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                            data-bs-toggle="modal"
                                            data-bs-target="#chatModal-@chat.ChatId">
                                        <span>@chat.SenderName</span>
                                        <span class="badge bg-info">@chat.LastMessage</span>
                                    </button>

                                    <!-- Modal para este chat -->
                                    <div class="modal fade" id="chatModal-@chat.ChatId" tabindex="-1">
                                        <div class="modal-dialog modal-lg">
                                            <div class="modal-content">
                                                <div class="modal-header bg-primary text-white">
                                                    <h5 class="modal-title">Chat con @chat.SenderName </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body" style="max-height:400px; overflow-y:auto;">
                                                    @foreach (var msg in chat.Messages!)
                                                    {
                                                        if (msg.isFromClient)
                                                        {
                                                            <div class="d-flex justify-content-start mb-2">
                                                                <div class="p-2 bg-light border rounded" style="max-width:70%;">
                                                                    <strong>@chat.SenderName:</strong> @msg.Content
                                                                    <div class="text-muted small">@msg.Date.ToString("g")</div>
                                                                </div>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <div class="d-flex justify-content-end mb-2">
                                                                <div class="p-2 bg-primary text-white rounded" style="max-width:70%;">
                                                                    <strong>Tú:</strong> @msg.Content
                                                                    <div class="text-light small">@msg.Date.ToString("g")</div>
                                                                </div>
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                                <div class="modal-footer">
                                                    <form asp-controller="Addons" asp-action="AddMessage" method="post" class="d-flex w-100">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="propertyId" value="@Model.Property.Id" />
                                                        <input type="hidden" name="chatId" value="@chat.ChatId" />
                                                        <input type="text" name="message" class="form-control me-2" placeholder="Escribe tu mensaje..." required />
                                                        <button type="submit" class="btn btn-primary"><i class="bi bi-send"></i></button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="p-3 text-muted">No tienes chats con clientes todavía.</div>
                            }
                        </div>
                        </div>
                    <!-- LISTADO DE CLIENTES CON OFERTAS -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-cash-coin"></i> Clientes con ofertas
                        </div>
                        <div class="card-body p-2">
                            @if (Model.Offers != null && Model.Offers.Any())
                            {
                                <ul class="list-group list-group-flush">
                                    @foreach (var group in Model.Offers.GroupBy(o => o.ClientId))
                                    {
                                        var clientName = group.First().ClientName;
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span>@clientName</span>
                                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalCliente@group.Key">
                                                <i class="bi bi-eye"></i> Ver ofertas
                                            </button>
                                        </li>

                                        <!-- MODAL DEL CLIENTE -->
                                        <div class="modal fade" id="modalCliente@group.Key" tabindex="-1" aria-labelledby="modalClienteLabel@group.Key" aria-hidden="true">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-success text-white">
                                                        <h5 class="modal-title" id="modalClienteLabel@group.Key">
                                                            Ofertas de @clientName
                                                        </h5>
                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                                                    </div>
                                                    <div class="modal-body p-2">
                                                        <table class="table table-sm align-middle mb-0">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Fecha</th>
                                                                    <th>Monto</th>
                                                                    <th>Estado</th>
                                                                    <th>Acciones</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var offer in group.OrderByDescending(o => o.Date))
                                                                {
                                                                    <tr>
                                                                        <td>@offer.Date.ToString("dd/MM/yyyy")</td>
                                                                        <td>RD$ @offer.Amount.ToString("N0")</td>
                                                                        <td>
                                                                            @if (offer.Status == Status.Pending)
                                                                            {
                                                                                <span class="badge bg-warning text-dark">Pendiente</span>
                                                                            }
                                                                            else if (offer.Status == Status.Accepted)
                                                                            {
                                                                                <span class="badge bg-success">Aceptada</span>
                                                                            }
                                                                            else
                                                                            {
                                                                                <span class="badge bg-danger">Rechazada</span>
                                                                            }
                                                                        </td>
                                                                        <td>
                                                                            @if (offer.Status == Status.Pending)
                                                                            {
                                                                                <div class="d-flex gap-1">
                                                                                    <form asp-controller="Addons" asp-action="UpdateOffer" method="post">
                                                                                        @Html.AntiForgeryToken()
                                                                                        <input type="hidden" name="offerId" value="@offer.Id" />
                                                                                        <input type="hidden" name="accept" value="true" />
                                                                                        <button type="submit" class="btn btn-sm btn-success" title="Aceptar">
                                                                                            <i class="bi bi-check-lg"></i>
                                                                                        </button>
                                                                                    </form>
                                                                                    <form asp-controller="Addons" asp-action="UpdateOffer" method="post">
                                                                                        @Html.AntiForgeryToken()
                                                                                        <input type="hidden" name="offerId" value="@offer.Id" />
                                                                                        <input type="hidden" name="accept" value="false" />
                                                                                        <button type="submit" class="btn btn-sm btn-danger" title="Rechazar">
                                                                                            <i class="bi bi-x-lg"></i>
                                                                                        </button>
                                                                                    </form>
                                                                                </div>
                                                                            }
                                                                        </td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted text-center my-2">Ningún cliente ha hecho ofertas todavía.</p>
                            }
                        </div>
                    </div>




                }
            }
        </div>
    </div>
</div>
